<!DOCTYPE html>
<html>
<head>
<base href="." />
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CIFI Admin Dashboard</title>

<!-- Core Web3 and Blockchain -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<!-- UI and Visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<!-- Time and Notifications -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Required CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --primary: #2C3E50;
  --secondary: #3498DB;
  --success: #2ECC71;
  --danger: #E74C3C;
  --warning: #F1C40F;
  --light: #ECF0F1;
  --dark: #2C3E50;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', sans-serif;
  background: var(--light);
  color: var(--dark);
}

.dashboard {
  display: grid;
  grid-template-columns: 250px 1fr;
  min-height: 100vh;
}

.sidebar {
  background: var(--primary);
  color: white;
  padding: 1rem;
}

.logo-container {
  width: 80px;
  height: 80px;
  margin: 0 auto 1rem auto;
  position: relative;
  border-radius: 50%;
  padding: 3px;
  background: linear-gradient(to right, #2ECC71, #1abc9c);
}

.logo-image {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  background: white;
}

.sidebar-header {
  padding: 1rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.nav-link {
  display: block;
  padding: 0.75rem 1rem;
  color: rgba(255,255,255,0.8);
  text-decoration: none;
  border-radius: 4px;
  margin: 0.25rem 0;
}

.nav-link:hover {
  background: rgba(255,255,255,0.1);
}

.main-content {
  padding: 2rem;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-card h3 {
  color: var(--secondary);
  margin-bottom: 0.5rem;
}

.network-selector {
  background: rgba(255,255,255,0.1);
  padding: 0.5rem;
  border-radius: 4px;
  margin: 1rem 0;
}

.network-selector select {
  width: 100%;
  padding: 0.5rem;
  background: transparent;
  color: white;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 4px;
}

.network-selector select option {
  background: var(--primary);
  color: white;
}

.product-table {
  width: 100%;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border-collapse: collapse;
}

.product-table th,
.product-table td {
  padding: 1rem;
  text-align: left;
  border-bottom: 1px solid var(--light);
}

.product-table th {
  background: var(--primary);
  color: white;
}

.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
}

.btn-primary {
  background: linear-gradient(to right, #2ECC71, #1abc9c);
  color: white;
  transition: all 0.3s ease;
  border: none;
}

.btn-primary:hover {
  background: linear-gradient(to right, #27AE60, #16a085);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(46, 204, 113, 0.2);
}

.btn-danger {
  background: var(--danger);
  color: white;
  transition: all 0.3s ease;
}

.btn-danger:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(231, 76, 60, 0.2);
}

.btn-warning {
  background: var(--warning);
  color: white;
  transition: all 0.3s ease;
}

.btn-warning:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(241, 196, 15, 0.2);
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.status-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 500;
}

.status-badge.active {
  background: rgba(46, 204, 113, 0.1);
  color: var(--success);
}

.status-badge.inactive {
  background: rgba(231, 76, 60, 0.1);
  color: var(--danger);
}

.emergency-badge {
  background: rgba(231, 76, 60, 0.1);
  color: var(--danger);
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 500;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}

.modal.show {
  display: block;
}

.modal-content {
  background: white;
  width: 90%;
  max-width: 500px;
  margin: 2rem auto;
  padding: 2rem;
  border-radius: 8px;
  position: relative;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.form-group input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.address-display {
  background: var(--primary);
  color: white;
  padding: 0.5rem;
  border-radius: 4px;
  font-size: 0.9rem;
  margin-top: 0.5rem;
}

.chart-container {
  background: white;
  padding: 1rem;
  border-radius: 8px;
  margin-top: 2rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.creators-section,
.emergency-section,
.analytics-section {
  background: white;
  padding: 1.5rem;
  border-radius: 8px;
  margin-top: 2rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.creator-controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.creator-controls input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.creators-list {
  margin-top: 1rem;
}

.emergency-controls {
  margin-bottom: 1rem;
}

.emergency-requests {
  background: rgba(231, 76, 60, 0.1);
  padding: 1rem;
  border-radius: 4px;
}

.emergency-request {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem;
  border-bottom: 1px solid rgba(231, 76, 60, 0.2);
}

.emergency-request:last-child {
  border-bottom: none;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  background: white;
  color: var(--dark);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 12px;
  transform: translateX(120%);
  transition: transform 0.3s ease-out;
  max-width: 400px;
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  border-left: 4px solid var(--success);
}

.notification.error {
  border-left: 4px solid var(--danger);
}

.notification.warning {
  border-left: 4px solid var(--warning);
}

.waiting-badge {
  background: rgba(241, 196, 15, 0.1);
  color: var(--warning);
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 500;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.header-actions {
  display: flex;
  gap: 0.5rem;
}

.action-buttons {
  display: flex;
  gap: 0.5rem;
}

</style>
</head>
<body>
<div class="dashboard">
  <!-- Sidebar -->
  <div class="sidebar">
    <!-- Sidebar content -->
    <div class="sidebar-header">
      <div class="logo-container">
        <img src="https://ipfs.io/ipfs/QmQX4HvtqdYVuJHm17JTyGkK1ttFitg4oAhPzXdy6psm1T" 
             alt="Company Logo" 
             class="logo-image">
      </div>
      <h2>CIFI VM Admin</h2>
      <div class="network-selector">
        <select id="network-select">
          <option value="50">XDC Mainnet</option>
          <option value="43114">Avalanche C-Chain</option>
          <option value="137">Polygon Mainnet</option>
        </select>
      </div>
      <div class="address-display" id="connected-address">
        Not Connected
      </div>
      <!-- Connect Wallet Button -->
      <button class="btn btn-primary" id="connect-wallet-btn">Connect Wallet</button>
    </div>
    
    <nav>
      <a href="#dashboard" class="nav-link" data-section="dashboard">Dashboard</a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Network Info -->
    <div class="network-info">
      <div class="current-network" id="current-network">
        Network: Not Connected
      </div>
      <div class="network-status" id="network-status"></div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Products</h3>
        <p id="total-products">Loading...</p>
      </div>
      <div class="stat-card">
        <h3>Total Revenue</h3>
        <p id="total-revenue">Loading...</p>
      </div>
      <div class="stat-card">
        <h3>Contract Balance</h3>
        <p id="contract-balance">Loading...</p>
      </div>
      <div class="stat-card">
        <h3>Contract Status</h3>
        <p id="contract-status">Loading...</p>
      </div>
    </div>

    <!-- Product Section -->
    <div class="product-section">
      <div class="section-header">
        <h2>Products</h2>
        <div class="header-actions">
          <button class="btn btn-primary" id="refresh-products">
            <i class="fas fa-sync"></i> Refresh
          </button>
          <button class="btn btn-primary" id="add-product-btn">
            <i class="fas fa-plus"></i> Add Product
          </button>
        </div>
      </div>

      <table class="product-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Price</th>
            <th>Supply</th>
            <th>Total Sold</th>
            <th>Revenue</th>
            <th>Status</th>
            <th>Emergency</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="product-list">
          <!-- Products will be populated here -->
        </tbody>
      </table>
    </div>

    <!-- Creators Section -->
    <div class="creators-section" id="creators-section">
      <h2>Creators Management</h2>
      <div class="creator-controls">
        <input type="text" id="creator-address" placeholder="Creator Address">
        <button class="btn btn-primary" id="whitelist-creator">Whitelist Creator</button>
      </div>
      <div class="creators-list-container">
        <h3>Whitelisted Creators</h3>
        <div id="creators-list" class="creators-list"></div>
      </div>
    </div>

    <!-- Emergency Section -->
    <div class="emergency-section" id="emergency-section">
      <h2>Emergency Controls</h2>
      <div class="emergency-controls">
        <button class="btn btn-danger" id="toggle-pause">Loading Contract State...</button>
      </div>
      <div class="emergency-requests">
        <h3>Emergency Withdrawal Requests</h3>
        <div id="emergency-list" class="emergency-list"></div>
      </div>
    </div>

    <!-- Analytics Section -->
    <div class="analytics-section">
      <h2>Analytics Dashboard</h2>
      <div class="analytics-grid">
        <div class="chart-container">
          <canvas id="sales-chart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="revenue-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div id="add-product-modal" class="modal">
  <div class="modal-content">
    <h2>Add New Product</h2>
    <form id="add-product-form">
      <div class="form-group">
        <label>Product Name</label>
        <input type="text" name="name" required>
      </div>
      <div class="form-group">
        <label>IPFS CID</label>
        <input type="text" name="ipfsCID" required>
      </div>
      <div class="form-group">
        <label>Product Token Address</label>
        <input type="text" name="productToken" required>
      </div>
      <div class="form-group">
        <label>Payment Token Address</label>
        <input type="text" name="paymentToken" placeholder="Use 0x000...000 for native token">
      </div>
      <div class="form-group">
        <label>Price (in Ether)</label>
        <input type="number" name="price" step="any" required>
      </div>
      <div class="form-group">
        <label>Beneficiary Address</label>
        <input type="text" name="beneficiary" required>
      </div>
      <button type="submit" class="btn btn-primary">Create Product</button>
      <button type="button" class="btn btn-secondary" onclick="closeModal('add-product-modal')">Cancel</button>
    </form>
  </div>
</div>

<!-- Update Product Modal -->
<div id="update-product-modal" class="modal">
  <div class="modal-content">
    <h2>Update Product</h2>
    <form id="update-product-form">
      <input type="hidden" name="productId">
      <div class="form-group">
        <label>New Price (in Ether)</label>
        <input type="number" name="newPrice" step="any">
      </div>
      <div class="form-group">
        <label>New IPFS CID</label>
        <input type="text" name="newIpfsCID">
      </div>
      <button type="submit" class="btn btn-primary">Update Product</button>
      <button type="button" class="btn btn-secondary" onclick="closeModal('update-product-modal')">Cancel</button>
    </form>
  </div>
</div>

<!-- Emergency Request Modal -->
<div id="emergency-request-modal" class="modal">
  <div class="modal-content">
    <h2>Emergency Withdrawal Request</h2>
    <p>Are you sure you want to request an emergency withdrawal for this product?</p>
    <p>This action will:</p>
    <ul>
      <li>Lock the product immediately</li>
      <li>Start a 24-hour countdown before withdrawal is possible</li>
      <li>Prevent any new purchases</li>
    </ul>
    <input type="hidden" id="emergency-product-id">
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="confirmEmergencyRequest()">Confirm Request</button>
      <button type="button" class="btn btn-secondary" onclick="closeModal('emergency-request-modal')">Cancel</button>
    </div>
  </div>
</div>

<script>
// Contract ABIs
const VENDING_MACHINE_ABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "status",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "CreatorWhitelisted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "EmergencyWithdrawalExecuted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "EmergencyWithdrawalRequested",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "Paused",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "productAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			}
		],
		"name": "ProductAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "locked",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductEmergencyLocked",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "paymentAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductPurchased",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductStatusChanged",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "newIpfsCID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "updater",
				"type": "address"
			}
		],
		"name": "ProductUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "Unpaused",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "EMERGENCY_WITHDRAWAL_DELAY",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "productToken",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "paymentToken",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			}
		],
		"name": "addProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdrawalRequested",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdrawalTime",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "executeEmergencyWithdrawal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "getProductBasicInfo",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "name",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "ipfsCID",
						"type": "string"
					},
					{
						"internalType": "address",
						"name": "productAddress",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "creator",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "beneficiary",
						"type": "address"
					},
					{
						"internalType": "bool",
						"name": "isActive",
						"type": "bool"
					},
					{
						"internalType": "bool",
						"name": "emergencyLocked",
						"type": "bool"
					}
				],
				"internalType": "struct TestVendingMachine.ProductBasicInfo",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getProductCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "getProductExtendedInfo",
		"outputs": [
			{
				"components": [
					{
						"internalType": "uint256",
						"name": "price",
						"type": "uint256"
					},
					{
						"internalType": "address",
						"name": "productToken",
						"type": "address"
					},
					{
						"internalType": "address",
						"name": "paymentToken",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "availableSupply",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "totalSold",
						"type": "uint256"
					},
					{
						"internalType": "uint256",
						"name": "totalRevenue",
						"type": "uint256"
					}
				],
				"internalType": "struct TestVendingMachine.ProductExtendedInfo",
				"name": "",
				"type": "tuple"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			}
		],
		"name": "isWhitelistedCreator",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "pause",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "paused",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "products",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "productAddress",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "emergencyLocked",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "purchaseProduct",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "recalibrateProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			}
		],
		"name": "requestEmergencyWithdrawal",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "creator",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "status",
				"type": "bool"
			}
		],
		"name": "setCreatorWhitelist",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "isActive",
				"type": "bool"
			}
		],
		"name": "setProductStatus",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "unpause",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "productId",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "newIpfsCID",
				"type": "string"
			}
		],
		"name": "updateProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "whitelistedCreators",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

const PRODUCT_CONTRACT_ABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_creator",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_vendingMachine",
				"type": "address"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "owner",
				"type": "address"
			}
		],
		"name": "OwnableInvalidOwner",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "OwnableUnauthorizedAccount",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "token",
				"type": "address"
			}
		],
		"name": "SafeERC20FailedOperation",
		"type": "error"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "ipfsCID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "productToken",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "paymentToken",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "price",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "beneficiary",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductDetailsSet",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "paymentAmount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "ProductPurchased",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "newIpfsCID",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "updater",
				"type": "address"
			}
		],
		"name": "ProductUpdated",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "vendingMachine",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			}
		],
		"name": "VendingMachineSet",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "beneficiary",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "emergencyLocked",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			}
		],
		"name": "emergencyWithdraw",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getProductDetails",
		"outputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_productToken",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_paymentToken",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_price",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_availableSupply",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "_isActive",
				"type": "bool"
			},
			{
				"internalType": "uint256",
				"name": "_totalSold",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_totalRevenue",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "_creator",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_beneficiary",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "_emergencyLocked",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "ipfsCID",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "isActive",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "isProductAvailable",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "name",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "paymentToken",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "price",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "productToken",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "purchaseProduct",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "paymentAmount",
				"type": "uint256"
			}
		],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "recalibrate",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bool",
				"name": "_isActive",
				"type": "bool"
			}
		],
		"name": "setActiveStatus",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "bool",
				"name": "_emergencyLocked",
				"type": "bool"
			}
		],
		"name": "setEmergencyLock",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_ipfsCID",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_productToken",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "_paymentToken",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_price",
				"type": "uint256"
			},
			{
				"internalType": "address",
				"name": "_beneficiary",
				"type": "address"
			}
		],
		"name": "setProductDetails",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalRevenue",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalSold",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "newIpfsCID",
				"type": "string"
			}
		],
		"name": "updateProduct",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "vendingMachine",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

// Network configurations
const NETWORKS = {
  50: {
    name: 'XDC Mainnet',
    rpcUrl: 'https://rpc.xinfin.network',
    vendingMachineAddress: '0x0F53b47424FaFc8501ADF7f40E9920aC8DA925D7',
    symbol: 'XDC',
    explorer: 'https://explorer.xinfin.network',
    chainParams: {
      chainId: '0x32',
      chainName: 'XDC Mainnet',
      nativeCurrency: { name: 'XDC', symbol: 'XDC', decimals: 18 },
      rpcUrls: ['https://rpc.xinfin.network'],
      blockExplorerUrls: ['https://explorer.xinfin.network']
    }
  },
  43114: {
    name: 'Avalanche C-Chain',
    rpcUrl: 'https://api.avax.network/ext/bc/C/rpc',
    vendingMachineAddress: '0xe90bCeef5AC65a36199Cfa29552FBCF36BE531A0',
    symbol: 'AVAX',
    explorer: 'https://snowtrace.io',
    chainParams: {
      chainId: '0xA86A',
      chainName: 'Avalanche C-Chain',
      nativeCurrency: { name: 'AVAX', symbol: 'AVAX', decimals: 18 },
      rpcUrls: ['https://api.avax.network/ext/bc/C/rpc'],
      blockExplorerUrls: ['https://snowtrace.io']
    }
  },
  137: {
    name: 'Polygon Mainnet',
    rpcUrl: 'https://polygon-rpc.com',
    vendingMachineAddress: '0xd3A42e2aDEc479dAd1C08F76a635da9e6bc888f5',
    symbol: 'POL',
    explorer: 'https://polygonscan.com',
    chainParams: {
      chainId: '0x89',
      chainName: 'Polygon Mainnet',
      nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
      rpcUrls: ['https://polygon-rpc.com'],
      blockExplorerUrls: ['https://polygonscan.com']
    }
  }
};

// Global variables
let web3;
let vendingMachineContract;
let currentAccount;
let currentChainId;
let products = [];

// Initialize the application
async function initApp() {
  // Check for MetaMask
  if (window.ethereum) {
    web3 = new Web3(window.ethereum);
    const accounts = await web3.eth.getAccounts();
    if (accounts.length > 0) {
      currentAccount = accounts[0];
      document.getElementById('connected-address').textContent = 
        `${currentAccount.substr(0,6)}...${currentAccount.substr(-4)}`;
    }
    currentChainId = await web3.eth.getChainId();

    // Load initial data
    await handleNetworkChange(currentChainId);

    // Set up event listeners
    setupEventListeners();
  } else {
    console.error('MetaMask not found');
    showNotification('error', 'MetaMask Not Found', 'Please install MetaMask to use this application.');
  }
}

// Handle network change
async function handleNetworkChange(chainId) {
  currentChainId = parseInt(chainId, 16) || chainId; // Convert hex to decimal if necessary
  const network = NETWORKS[currentChainId];

  if (!network) {
    showNotification('error', 'Unsupported Network', 'Please switch to a supported network.');
    return;
  }

  // Initialize vending machine contract
  vendingMachineContract = new web3.eth.Contract(VENDING_MACHINE_ABI, network.vendingMachineAddress);

  // Update UI
  document.getElementById('current-network').textContent = `Network: ${network.name}`;

  // Update network selector
  document.getElementById('network-select').value = currentChainId;

  // Load dashboard data
  await loadDashboardData();
}

// Handle account change
async function handleAccountChange(accounts) {
  if (accounts.length === 0) {
    currentAccount = null;
    document.getElementById('connected-address').textContent = 'Not Connected';
    showNotification('warning', 'Disconnected', 'Please connect your wallet');
  } else {
    currentAccount = accounts[0];
    document.getElementById('connected-address').textContent = 
      `${currentAccount.substr(0,6)}...${currentAccount.substr(-4)}`;
    await loadDashboardData();
  }
}

// Load dashboard data
async function loadDashboardData() {
  try {
    const [
      productCount,
      isPaused,
      balance
    ] = await Promise.all([
      vendingMachineContract.methods.getProductCount().call(),
      vendingMachineContract.methods.paused().call(),
      web3.eth.getBalance(vendingMachineContract.options.address)
    ]);

    // Update stats
    document.getElementById('total-products').textContent = productCount;
    document.getElementById('contract-balance').textContent = 
      `${web3.utils.fromWei(balance)} ${NETWORKS[currentChainId].symbol}`;
    document.getElementById('contract-status').textContent = isPaused ? 'Paused' : 'Active';
    document.getElementById('toggle-pause').textContent = isPaused ? 'Unpause Contract' : 'Pause Contract';

    // Load products
    await loadProducts(productCount);

    // Load emergency requests
    await loadEmergencyRequests();

    // Update analytics
    updateAnalytics();
  } catch (error) {
    console.error('Error loading dashboard data:', error);
    showNotification('error', 'Data Load Error', formatError(error));
  }
}

// Load products
async function loadProducts(productCount) {
  products = [];
  const productList = document.getElementById('product-list');
  productList.innerHTML = '';

  for (let i = 0; i < productCount; i++) {
    try {
      // Fetch product basic and extended info
      const [basicInfo, extendedInfo] = await Promise.all([
        vendingMachineContract.methods.getProductBasicInfo(i).call(),
        vendingMachineContract.methods.getProductExtendedInfo(i).call()
      ]);

      const product = {
        id: i,
        name: basicInfo.name,
        ipfsCID: basicInfo.ipfsCID,
        productAddress: basicInfo.productAddress,
        creator: basicInfo.creator,
        beneficiary: basicInfo.beneficiary,
        isActive: basicInfo.isActive,
        emergencyLocked: basicInfo.emergencyLocked,
        price: extendedInfo.price,
        productToken: extendedInfo.productToken,
        paymentToken: extendedInfo.paymentToken,
        availableSupply: extendedInfo.availableSupply,
        totalSold: extendedInfo.totalSold,
        totalRevenue: extendedInfo.totalRevenue
      };

      // Add product to global array
      products.push(product);

      // Render product row
      renderProductRow(product);

    } catch (error) {
      console.error(`Error loading product ${i}:`, error);
    }
  }
}

// Render product row
function renderProductRow(product) {
  const productList = document.getElementById('product-list');
  const networkSymbol = NETWORKS[currentChainId].symbol;
  const row = document.createElement('tr');

  row.innerHTML = `
    <td>${product.id}</td>
    <td>${product.name}</td>
    <td>${web3.utils.fromWei(product.price)} ${networkSymbol}</td>
    <td>${web3.utils.fromWei(product.availableSupply.toString())}</td>
    <td>${web3.utils.fromWei(product.totalSold.toString())}</td>
    <td>${web3.utils.fromWei(product.totalRevenue.toString())} ${networkSymbol}</td>
    <td>
      <span class="status-badge ${product.isActive ? 'active' : 'inactive'}">
        ${product.isActive ? 'Active' : 'Inactive'}
      </span>
    </td>
    <td>
      ${product.emergencyLocked ? 
        '<span class="emergency-badge">Locked</span>' : 
        `<button class="btn btn-warning btn-sm" onclick="showEmergencyModal(${product.id})">Request</button>`
      }
    </td>
    <td>
      <div class="action-buttons">
        <button class="btn btn-primary btn-sm" onclick="showUpdateModal(${product.id})">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn ${product.isActive ? 'btn-danger' : 'btn-success'} btn-sm" 
                onclick="toggleProduct(${product.id})">
          ${product.isActive ? '<i class="fas fa-times"></i>' : '<i class="fas fa-check"></i>'}
        </button>
      </div>
    </td>
  `;

  productList.appendChild(row);
}

// Load emergency requests
async function loadEmergencyRequests() {
  const emergencyList = document.getElementById('emergency-list');
  emergencyList.innerHTML = '';
  
  const requests = [];
  const productCount = await vendingMachineContract.methods.getProductCount().call();
  
  for (let i = 0; i < productCount; i++) {
    const isRequested = await vendingMachineContract.methods.emergencyWithdrawalRequested(i).call();
    if (isRequested) {
      const [product, withdrawalTime] = await Promise.all([
        vendingMachineContract.methods.getProductBasicInfo(i).call(),
        vendingMachineContract.methods.emergencyWithdrawalTime(i).call()
      ]);
      
      const timeLeft = (parseInt(withdrawalTime) + 86400) - Math.floor(Date.now() / 1000);
      
      requests.push(`
        <div class="emergency-request">
          <div class="request-info">
            <span>Product #${i}: ${product.name}</span>
            <span class="time-left">${timeLeft > 0 ? `${Math.floor(timeLeft / 3600)}h ${Math.floor((timeLeft % 3600) / 60)}m left` : 'Ready for withdrawal'}</span>
          </div>
          ${timeLeft <= 0 ? 
            `<button class="btn btn-danger" onclick="executeEmergencyWithdrawal(${i})">
              Execute Withdrawal
             </button>` : 
            '<span class="waiting-badge">Waiting</span>'
          }
        </div>
      `);
    }
  }
  
  emergencyList.innerHTML = requests.join('') || '<p>No emergency requests</p>';
}

// Add Product
async function addProduct(formData) {
  try {
    const name = formData.get('name').trim();
    const ipfsCID = formData.get('ipfsCID').trim();
    const productToken = formData.get('productToken').trim();
    let paymentToken = formData.get('paymentToken').trim();
    const price = formData.get('price').trim();
    const beneficiary = formData.get('beneficiary').trim();

    if (!web3.utils.isAddress(productToken) || !web3.utils.isAddress(beneficiary)) {
      showNotification('error', 'Invalid Address', 'Please enter valid Ethereum addresses.');
      return;
    }

    if (!paymentToken) {
      paymentToken = '0x0000000000000000000000000000000000000000';
    } else if (!web3.utils.isAddress(paymentToken)) {
      showNotification('error', 'Invalid Payment Token Address', 'Please enter a valid payment token address.');
      return;
    }

    const priceInWei = web3.utils.toWei(price.toString(), 'ether');

    await vendingMachineContract.methods.addProduct(
      name,
      ipfsCID,
      productToken,
      paymentToken,
      priceInWei,
      beneficiary
    ).send({ from: currentAccount });

    closeModal('add-product-modal');
    showNotification('success', 'Success', 'Product added successfully');
    await loadDashboardData();
  } catch (error) {
    console.error('Error adding product:', error);
    showNotification('error', 'Error', formatError(error));
  }
}

// Update Product
async function updateProduct(formData) {
  try {
    const productId = formData.get('productId');
    const newPrice = formData.get('newPrice').trim();
    const newIpfsCID = formData.get('newIpfsCID').trim();

    let newPriceInWei = '0';
    if (newPrice) {
      newPriceInWei = web3.utils.toWei(newPrice.toString(), 'ether');
    }

    await vendingMachineContract.methods.updateProduct(
      productId,
      newPriceInWei,
      newIpfsCID
    ).send({ from: currentAccount });

    closeModal('update-product-modal');
    showNotification('success', 'Success', 'Product updated successfully');
    await loadDashboardData();
  } catch (error) {
    console.error('Error updating product:', error);
    showNotification('error', 'Error', formatError(error));
  }
}

// Toggle Product Status
async function toggleProduct(productId) {
  try {
    const basicInfo = await vendingMachineContract.methods.getProductBasicInfo(productId).call();
    await vendingMachineContract.methods.setProductStatus(productId, !basicInfo.isActive)
      .send({ from: currentAccount });
    
    showNotification('success', 'Success', `Product ${basicInfo.isActive ? 'deactivated' : 'activated'}`);
    await loadDashboardData();
  } catch (error) {
    console.error('Error toggling product status:', error);
    showNotification('error', 'Error', formatError(error));
  }
}

// Request Emergency Withdrawal
async function requestEmergencyWithdrawal(productId) {
  try {
    await vendingMachineContract.methods.requestEmergencyWithdrawal(productId)
      .send({ from: currentAccount });
    
    closeModal('emergency-request-modal');
    showNotification('success', 'Success', 'Emergency withdrawal requested');
    await loadDashboardData();
  } catch (error) {
    console.error('Error requesting emergency withdrawal:', error);
    showNotification('error', 'Error', formatError(error));
  }
}

// Execute Emergency Withdrawal
async function executeEmergencyWithdrawal(productId) {
  try {
    await vendingMachineContract.methods.executeEmergencyWithdrawal(productId)
      .send({ from: currentAccount });
    
    showNotification('success', 'Success', 'Emergency withdrawal executed');
    await loadDashboardData();
  } catch (error) {
    console.error('Error executing emergency withdrawal:', error);
    showNotification('error', 'Error', formatError(error));
  }
}

// Toggle Contract Pause
async function togglePause() {
  try {
    const isPaused = await vendingMachineContract.methods.paused().call();
    await vendingMachineContract.methods[isPaused ? 'unpause' : 'pause']()
      .send({ from: currentAccount });
    
    showNotification('success', 'Success', `Contract ${isPaused ? 'unpaused' : 'paused'}`);
    await loadDashboardData();
  } catch (error) {
    console.error('Error toggling contract pause:', error);
    showNotification('error', 'Error', formatError(error));
  }
}

// Whitelist Creator
async function whitelistCreator() {
  const address = document.getElementById('creator-address').value.trim();
  if (!web3.utils.isAddress(address)) {
    showNotification('error', 'Invalid Address', 'Please enter a valid Ethereum address.');
    return;
  }
  try {
    await vendingMachineContract.methods.setCreatorWhitelist(address, true)
      .send({ from: currentAccount });
    
    showNotification('success', 'Success', 'Creator whitelisted');
    document.getElementById('creator-address').value = '';
    await loadDashboardData();
  } catch (error) {
    console.error('Error whitelisting creator:', error);
    showNotification('error', 'Error', formatError(error));
  }
}

// Update Analytics
function updateAnalytics() {
  if (!products.length) return;

  const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
  const salesCtx = document.getElementById('sales-chart').getContext('2d');
  
  // Destroy existing charts if they exist
  if (window.revenueChart) window.revenueChart.destroy();
  if (window.salesChart) window.salesChart.destroy();
  
  const chartData = products.map(p => ({
    name: p.name,
    revenue: parseFloat(web3.utils.fromWei(p.totalRevenue)),
    sales: parseFloat(web3.utils.fromWei(p.totalSold))
  }));

  // Revenue Chart
  window.revenueChart = new Chart(revenueCtx, {
    type: 'bar',
    data: {
      labels: chartData.map(d => d.name),
      datasets: [{
        label: 'Revenue',
        data: chartData.map(d => d.revenue),
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Product Revenue Distribution'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: NETWORKS[currentChainId].symbol
          }
        }
      }
    }
  });

  // Sales Chart
  window.salesChart = new Chart(salesCtx, {
    type: 'line',
    data: {
      labels: chartData.map(d => d.name),
      datasets: [{
        label: 'Sales',
        data: chartData.map(d => d.sales),
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        tension: 0.1,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Product Sales Overview'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Units Sold'
          }
        }
      }
    }
  });

  // Update total revenue
  const totalRevenue = chartData.reduce((sum, product) => sum + product.revenue, 0);
  document.getElementById('total-revenue').textContent = 
    `${totalRevenue.toFixed(2)} ${NETWORKS[currentChainId].symbol}`;
}

// UI Helper Functions
function showNotification(type, title, message) {
  toastr[type](message, title);
}

function showModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.add('show');
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.remove('show');
}

function showUpdateModal(productId) {
  const form = document.getElementById('update-product-form');
  form.elements['productId'].value = productId;

  const product = products.find(p => p.id === productId);
  form.elements['newPrice'].value = web3.utils.fromWei(product.price);
  form.elements['newIpfsCID'].value = product.ipfsCID;

  showModal('update-product-modal');
}

function showEmergencyModal(productId) {
  document.getElementById('emergency-product-id').value = productId;
  showModal('emergency-request-modal');
}

function confirmEmergencyRequest() {
  const productId = document.getElementById('emergency-product-id').value;
  requestEmergencyWithdrawal(productId);
}

// Error Formatting
function formatError(error) {
  if (error.message) {
    if (error.message.includes('User denied')) {
      return 'Transaction rejected by user';
    }
    if (error.message.includes('insufficient funds')) {
      return 'Insufficient funds for transaction';
    }
    return error.message;
  }
  return 'An unexpected error occurred';
}

// Connect Wallet
async function connectWallet() {
  if (window.ethereum) {
    try {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      currentAccount = accounts[0];
      document.getElementById('connected-address').textContent = 
        `${currentAccount.substr(0,6)}...${currentAccount.substr(-4)}`;

      currentChainId = await web3.eth.getChainId();
      await handleNetworkChange(currentChainId);

      showNotification('success', 'Connected', 'Successfully connected to wallet');
    } catch (error) {
      console.error('Error connecting to wallet:', error);
      showNotification('error', 'Connection Failed', formatError(error));
    }
  } else {
    showNotification('error', 'MetaMask Not Found', 'Please install MetaMask to use this application.');
  }
}

// Switch Network
async function switchNetwork(targetChainId) {
  try {
    const networkConfig = NETWORKS[targetChainId];
    if (!networkConfig) throw new Error('Unsupported network');

    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: networkConfig.chainParams.chainId }]
    });
  } catch (error) {
    if (error.code === 4902) {
      try {
        const networkConfig = NETWORKS[targetChainId];
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [networkConfig.chainParams]
        });
      } catch (addError) {
        console.error('Error adding network:', addError);
        showNotification('error', 'Network Error', 'Failed to add network to MetaMask');
      }
    } else {
      console.error('Error switching network:', error);
      showNotification('error', 'Network Error', 'Failed to switch network');
    }
  }
}

// Event Listeners Setup
function setupEventListeners() {
  // MetaMask events
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', handleAccountChange);
    window.ethereum.on('chainChanged', handleNetworkChange);
  }

  // Connect wallet button
  document.getElementById('connect-wallet-btn').addEventListener('click', connectWallet);

  // Network selector
  document.getElementById('network-select').addEventListener('change', async (e) => {
    await switchNetwork(parseInt(e.target.value));
  });

  // Add product form
  document.getElementById('add-product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    await addProduct(new FormData(e.target));
  });

  // Update product form
  document.getElementById('update-product-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    await updateProduct(new FormData(e.target));
  });

  // Whitelist creator button
  document.getElementById('whitelist-creator').addEventListener('click', whitelistCreator);

  // Toggle pause button
  document.getElementById('toggle-pause').addEventListener('click', togglePause);

  // Refresh products button
  document.getElementById('refresh-products').addEventListener('click', loadDashboardData);

  // Add product button
  document.getElementById('add-product-btn').addEventListener('click', () => {
    showModal('add-product-modal');
  });

  // Close modals when clicking outside
  window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
      closeModal(e.target.id);
    }
  });
}

// Initialize application on page load
window.addEventListener('load', initApp);
</script>
</body>
</html>
